# NDM 性能优化指南

本文档详细说明了对 NDM 项目进行的性能优化措施。

## 优化概览

### 1. 数据库性能优化

#### 连接池优化
- **预编译语句缓存**: 启用 `PrepareStmt: true` 减少SQL解析开销
- **连接池配置**: 
  - 最大空闲连接数: 10
  - 最大打开连接数: CPU核心数 × 10
  - 连接最大生存时间: 1小时
- **外键约束优化**: 在迁移时禁用外键约束检查

#### 查询优化
- **用户查询缓存**: 实现内存缓存机制，缓存时间5分钟
- **缓存键策略**: 使用 `user:username` 格式的缓存键
- **自动过期清理**: 定时清理过期缓存项

### 2. HTTP服务器优化

#### 中间件优化
- **性能监控**: 实时监控请求处理时间和性能指标
- **并发控制**: 限制最大并发连接数为1000
- **请求大小限制**: 限制单个请求最大10MB
- **安全头**: 添加安全相关HTTP头
- **CORS优化**: 高效的跨域资源共享处理

#### 服务器配置
- **超时设置**:
  - 读取超时: 30秒
  - 写入超时: 30秒
  - 空闲超时: 60秒
- **最大头部大小**: 1MB
- **自定义Gin引擎**: 移除不必要的默认中间件

### 3. 内存管理优化

#### 缓存系统
- **LRU缓存**: 实现最近最少使用算法
- **自动过期**: 基于TTL的自动过期机制
- **内存限制**: 最大缓存项数量1000
- **统计信息**: 提供缓存命中率等统计数据

#### 文件流处理
- **缓冲区优化**: 
  - 默认缓冲区: 64KB
  - 大文件缓冲区: 1MB
  - 内存缓冲区: 32MB
- **动态缓冲区**: 根据文件大小自动选择最优缓冲区

### 4. 并发处理优化

#### 工作池
- **动态工作池**: 根据CPU核心数自动调整工作协程数量
- **任务队列**: 1000个任务的缓冲队列
- **优雅关闭**: 支持优雅停止和资源清理
- **错误处理**: 完善的panic恢复和错误日志

#### 协程管理
- **工作协程数**: CPU核心数 × 2
- **队列大小**: 1000
- **超时控制**: 支持任务执行超时

### 5. 配置管理优化

#### 性能配置集中化
- **统一配置**: 所有性能相关配置集中在 `performance.go`
- **动态调整**: 根据系统资源自动调整配置
- **配置验证**: 启动时验证配置合理性

## 性能监控

### 监控指标
- **请求处理时间**: 平均、最大、最小响应时间
- **请求计数**: 总请求数统计
- **慢请求告警**: 超过1秒的请求自动记录
- **缓存命中率**: 缓存效果监控
- **并发连接数**: 实时连接数监控

### 监控接口
```go
// 获取性能指标
metrics := middlewares.GetMetrics()

// 获取缓存统计
stats := cache.GetStats()

// 获取工作池状态
poolStats := workerPool.GetStats()
```

## 使用建议

### 1. 生产环境配置
```go
// 推荐的生产环境配置
Performance.DB.MaxOpenConns = runtime.NumCPU() * 15
Performance.HTTP.MaxConcurrent = 2000
Performance.Cache.MaxCacheSize = 5000
```

### 2. 监控告警
- 设置慢请求告警阈值
- 监控内存使用情况
- 定期检查缓存命中率
- 监控数据库连接池状态

### 3. 性能调优
- 根据实际负载调整并发限制
- 根据内存情况调整缓存大小
- 根据网络情况调整超时设置
- 定期分析性能指标进行优化

## 预期性能提升

### 数据库查询
- **用户查询**: 缓存命中时响应时间减少90%
- **连接复用**: 减少连接建立开销
- **预编译语句**: SQL执行效率提升20-30%

### HTTP处理
- **并发处理**: 支持更高的并发连接数
- **响应时间**: 平均响应时间减少15-25%
- **资源利用**: CPU和内存使用更加高效

### 文件操作
- **大文件处理**: 处理速度提升30-50%
- **内存使用**: 减少不必要的内存分配
- **并发文件操作**: 支持更高的并发文件处理

## 注意事项

1. **内存监控**: 缓存会占用额外内存，需要监控内存使用
2. **配置调整**: 根据实际硬件资源调整配置参数
3. **日志级别**: 生产环境建议关闭详细日志以提升性能
4. **定期清理**: 定期清理过期缓存和临时文件
5. **版本兼容**: 确保所有依赖库版本兼容

## 故障排查

### 常见问题
1. **内存泄漏**: 检查缓存清理机制
2. **连接池耗尽**: 调整数据库连接池配置
3. **响应超时**: 检查超时配置和网络状况
4. **并发限制**: 根据负载调整并发限制

### 调试工具
- 使用 `pprof` 进行性能分析
- 监控 Goroutine 数量
- 检查内存分配情况
- 分析CPU使用率